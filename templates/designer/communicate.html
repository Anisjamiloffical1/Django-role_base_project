{% extends 'accounts/main.html' %}
{% load static %}

{% block content %}
<div class="container mt-4">
  <div class="card">
    <div class="card-header bg-primary text-white">
      <h3 class="mb-0">
        {% if order %}
          Message About Order #{{ order.id }}
        {% else %}
          New Message
        {% endif %}
      </h3>
    </div>
    
    <div class="card-body">
      <form method="post" enctype="multipart/form-data" id="message-form">
        {% csrf_token %}
        
        <!-- Hidden order field if pre-set -->
        {% if order %}
          <input type="hidden" name="order" value="{{ order.id }}">
        {% else %}
          <div class="mb-3">
            <label class="form-label">Related Order</label>
            {{ form.order }}
            <small class="text-muted">Optional - select if this relates to a specific order</small>
          </div>
        {% endif %}
        
        <!-- Receiver field -->
        <div class="mb-3">
          <label class="form-label">To</label>
          {{ form.receiver }}
        </div>
        
        <!-- Subject field -->
        <div class="mb-3">
          <label class="form-label">Subject</label>
          {{ form.subject }}
        </div>
        
        <!-- Message content -->
        <div class="mb-3">
          <label class="form-label">Message</label>
          {{ form.message }}
        </div>
        
        <!-- Attachment field -->
        <div class="mb-4">
          <label class="form-label">Attachment</label>
          {{ form.attachment }}
          <div id="file-help" class="form-text">
            Max 5MB. Allowed: PDF, JPG, PNG, AI, EPS files
          </div>
          <div id="file-preview" class="mt-2 d-none">
            <img id="preview-image" src="#" alt="Preview" class="img-thumbnail" style="max-height: 200px; display: none;">
            <div id="file-info" class="small mt-1"></div>
          </div>
        </div>
        
        <div class="d-flex justify-content-between">
          <a href="{% if order %}{% url 'designer-order-detail' pk=order.id %}{% else %}{% url 'designer-dashboard' %}{% endif %}" 
             class="btn btn-secondary">
            Cancel
          </a>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-paper-plane me-1"></i> Send Message
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Preview script -->
<script>
document.getElementById('id_attachment').addEventListener('change', function(e) {
  const file = e.target.files[0];
  const previewDiv = document.getElementById('file-preview');
  const previewImg = document.getElementById('preview-image');
  const fileInfo = document.getElementById('file-info');
  
  if (file) {
    previewDiv.classList.remove('d-none');
    fileInfo.innerHTML = `
      <strong>Selected file:</strong> ${file.name}<br>
      <strong>Type:</strong> ${file.type}<br>
      <strong>Size:</strong> ${(file.size/1024).toFixed(2)} KB
    `;
    
    // Show image preview if image file
    if (file.type.startsWith('image/')) {
      previewImg.style.display = 'block';
      const reader = new FileReader();
      reader.onload = function(e) {
        previewImg.src = e.target.result;
      }
      reader.readAsDataURL(file);
    } else {
      previewImg.style.display = 'none';
    }
  } else {
    previewDiv.classList.add('d-none');
  }
});
</script>

<style>
  /* Custom styles */
  .card {
    max-width: 800px;
    margin: 0 auto;
  }
  #message-form label {
    font-weight: 500;
  }
  #file-preview {
    border-left: 3px solid #0d6efd;
    padding-left: 10px;
  }
</style>
{% endblock %}