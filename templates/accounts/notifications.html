{% extends 'accounts/main.html' %}
{% load static %}

{% block content %}

<h2>Your Notifications 
  <span id="notif-count" class="badge bg-danger">{{ unread_count }}</span>
</h2>

<ul class="notification-list list-group mt-3">
  {% for notification in notifications %}
  <li id="notif-{{ notification.id }}" 
      class="list-group-item d-flex justify-content-between align-items-center {% if not notification.is_read %}unread{% endif %}">
    
    <div>
      {% if notification.order %}
        <a href="{% url 'order-detail' pk=notification.order.id %}">
          {{ notification.message }}
        </a>
      {% else %}
        {{ notification.message }}
      {% endif %}
      <br>
      <small class="text-muted">{{ notification.created_at|timesince }} ago</small>
    </div>

    {% if not notification.is_read %}
    <button class="btn btn-sm btn-outline-secondary mark-read" 
            data-id="{{ notification.id }}" 
            data-url="{% url 'mark_notification_read' pk=notification.id %}">
      Ã—
    </button>
    {% endif %}
  </li>
  {% empty %}
  <li class="list-group-item">No notifications</li>
  {% endfor %}
</ul>

<style>
  .unread {
    background-color: #f8f9fa;
    font-weight: bold;
  }
</style>

<script>
document.addEventListener("DOMContentLoaded", function() {

  // Get CSRF token from cookies
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      document.cookie.split(';').forEach(cookie => {
        let [key, value] = cookie.trim().split('=');
        if (key === name) cookieValue = decodeURIComponent(value);
      });
    }
    return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');

  // Attach click event to each mark-read button
  document.querySelectorAll(".mark-read").forEach(btn => {
    btn.addEventListener("click", function(e) {
      e.preventDefault();
      const id = this.dataset.id;
      const url = this.dataset.url;

      fetch(url, {
        method: "POST",
        headers: {
          "X-CSRFToken": csrftoken,
          "Accept": "application/json",
          "Content-Type": "application/json"
        }
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === "ok") {
          // Remove unread style
          const li = document.getElementById(`notif-${id}`);
          li.classList.remove("unread");
          // Remove button
          this.remove();
          // Update badge count
          const countEl = document.getElementById("notif-count");
          const current = parseInt(countEl.innerText);
          if (current > 0) countEl.innerText = current - 1;
        }
      })
      .catch(err => console.log(err));
    });
  });

});
</script>
<script>
  fetch(url, {
    method: "POST",
    headers: {
        "X-CSRFToken": csrftoken,
        "Accept": "application/json",
        "Content-Type": "application/json"
    }
})
.then(res => res.json())
.then(data => {
    if (data.status === "ok") {
        const li = document.getElementById(`notif-${id}`);
        li.classList.remove("unread");
        this.remove();

        const countEl = document.getElementById("notif-count");
        const current = parseInt(countEl.innerText);
        if (current > 0) countEl.innerText = current - 1;
    }
});
</script>

{% endblock %}
